<html>
 <head>
    <meta charset="UTF-8">
    <!-- https://blueprintcss.dev/docs -->
    <link href="https://unpkg.com/blueprint-css@3.1.3/dist/blueprint.min.css" rel="stylesheet" />


    <!--Load the AJAX API for visualizing stacked bars-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>

    <!-- Pagination via CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.6.0/pagination.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.6.0/pagination.js">
    </script>

        <!--Load the AJAX API for visualizing stacked bars-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<title>$test_type with $exec</title>
  <style>
    body {   font-family: Sans-Serif; }

h1, h2, h3, p {
  font-family: Arial, Helvetica, sans-serif;
}


table, table {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

table td, table th {
  border: 1px solid #ddd;
  padding: 8px;
}

table tr:nth-child(even){background-color: #f2f2f2;}

table tr:hover {background-color: #ddd;}

th {
    font-weight: bold;
    text-align: center;
}

table th {
  padding-left: 20px;
  padding-right: 20px;
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #04AA6D;
  color: white;
}

/*
table td, table th {
  background-color: #04AA6D;
  border: 1px solid #ddd;
  padding: 12px;
}

table tr:nth-child(even){background-color: #f2f2f2;}

table tr:hover {background-color: #ddd;}

th {
    font-weight: bold;
    text-align: center;
    padding-left: 20px;
    padding-right: 20px;
}

table {
  padding-left: 20px;
  padding-right: 20px;
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #04AA6D;
  color: white;
}
*/
  </style>

    <script type="text/javascript">

      // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(drawChart);

     // Callback that creates and populates a data table
     // Instantiates it with data, and draws it.
     // TODO: Update with all the data loaded
     function drawChart() {
       // For each test type:
       //   Get a div for the chart
       let chart = document.getElementById('chart_div')
       //   Create data for each executor in all versions under that test type
       //   Set up options and links
       //   Get the div where the output should be drawn s chart
       if (chart) {
         chart.draw(data, options);
       }
     }
    function toggleElement(id) {
      const element = document.getElementById(id);
      if (element.style.display === "none") {
        element.style.display = "block";
      } else {
        element.style.display = "none";
      }
    }

    const characterized_failure_labels =
      $characterized_failure_labels;

    let selectedSet = null;
    let accum_boxes = [];
    function checkboxChanged(box) {
      // Update the group selected with the intersection of values
      selectedSet = null;
      let first = true;
      for (let index in characterized_failure_labels) {
        const tag = characterized_failure_labels[index];
        const check_item = document.getElementById(tag);
        if (check_item.checked) {
          const label_string = check_item.value;
          const str_len = label_string.length;
          const labels = label_string.substring(2, str_len - 2). split("', '");
          const newSet = new Set(labels);

          if (first) {
             selectedSet = newSet;
             first = false;
          } else {
             selectedSet = new Set([...selectedSet].filter((x) => newSet.has(x)));
          }
        }
      }
     // Do something with the selected set.
     const newSize = selectedSet == null ? 0 : selectedSet.size;
     const output = document.getElementById('selectedCount');
     if (output) output.innerHTML = output.value = newSize;
     return newSize;
    }

    function showSelectedItems() {
      // Take the selected set and turn on row with that label in the tables.
      // Turn off the others.

      // If no items are selected, however, show all rows.
      let all_tr_elements = document.body.getElementsByTagName("tr");
      if (selectedSet == null || selectedSet.length == 0) {
        // Turn everything on!
        for (let index in all_tr_elements) {
          let element = all_tr_elements[index];
          if (element.style) {
            element.style.visibility = "visible";
            element.style.display = "table-row";
          }
        }
        return;
      }
      for (let index in all_tr_elements) {
        // Display only those selected.
        let element = all_tr_elements[index];
        const id = element.id;
        if (id) {
          if (selectedSet.has(id)) {
            // Show it
              if (element.style) {
                element.style.visibility = "visible";
                element.style.display = "table-row";
              }
            } else {
            // Turn it off
            if (element.style) {
              element.style.visibility = "collapse";
              //element.style.display = "none";
            }
          }
        }
      }
    }

    function loadJson(json_data) {

    }

    // Get the JSON data from the tests.
    let pass_json;
    let fail_json;
    let error_json;
    let unsupported_json;

    fetch('./pass/pass.json')
      .then((response) => response.json())
      .then((data) => {pass_json = data});
    fetch('./failing_tests/failing_tests.json')
      .then((response) => response.json())
      .then((data) => {fail_json = data});
    fetch('./test_errors/test_errors.json')
      .then((response) => error_json = response.json())
      .then((data) => {error_json = data});
    fetch('./unsupported/unsupported.json')
      .then((response) => unsupportd_json = response.json())
      .then((data) => {unsupported_json = data});

    // UL Template for pagination
    function simpleTemplating(data) {
        let possible_fields = ['label', 'expected', 'result',
                               'options', 'input_data'];
        let html = ['<table>'];
        for (let key of possible_fields) {
            if (key in data[0]) {
                html.push('<th>' + key +'</th>');
            }
        }

        html.push('</tr>');
        $.each(data, function(index, item){
            html.push("<tr>");
            for (let key of possible_fields) {
                if (key in data[0]) {
                    let output;
                    if (typeof item[key] == 'object') {
                        output = JSON.stringify(item[key]);
                    } else {
                        output = item[key];
                    }
                    html.push('<td>' + output +'</td>');
                }
            }
            html.push("</tr>");
        });

        html.push('</table>');
        return html.join('\n');
    }

    function onloadFn() {
        // Set up the pagination of each set of results
        // Do this for each class of results.
        const container_types = [
            {'type': 'failing', 'data': fail_json},
            {'type': 'passing', 'data': pass_json},
            {'type':'unsupported', 'data': unsupported_json},
            {'type': 'error', 'data': error_json}
        ];

        for (c_type of container_types) {
            let container_type = c_type['type'];
            let data_json = c_type['data'];
            if (data_json == 'undefined') {
                // This may be an error
                continue;
            }
            let pagination_container_name = '#' + container_type +
                '-pagination-container';
            let pagination_container = $(pagination_container_name);
            let data_container_name = '#' + container_type +
                '-data-container';
            let data_container = $(data_container_name);
            pagination_container.pagination({
                dataSource: data_json,
                pageSize: 20,
                showSizeChanger: true,
                showGoInput: true,
                showGoButton: true,
                showNavigator: true,
                formatGoInput: 'Go to page <%= input %>',
                formatNavigator: '<%= rangeStart %>-<%= rangeEnd %> of <%= totalNumber %> items',
                position: 'top',
                callback: function(data, pagination) {
                    // template method of yourself
                    var html = simpleTemplating(data);
                    data_container.html(html);
                }
            })
        }
    }

</script>
  </head>
  <body onload=onloadFn()>
    <h1>Verification report: $test_type on $exec</h1>
    <h2>Test details</h2>
    <h2>Platform information</h2>
    <details>
      <summary>
        <h2>Test summary</h2>
        <p>$platform_info</p>
        <p>Result file created: $timestamp
        <p>Total: $total_tests.
        <p>Pass: $passing_tests, Fail: $failing_tests, Errors: $error_count, Unsupported: $unsupported_count</p>
      </summary>
      <p>$test_environment</p>
    </details>

    <details>
      <summary>
        <h2>Passing tests ($passing_tests)</h2>
      </summary>
      <!-- Using pagination.js -->
      <div id="passing-pagination-container"></div>
      <div id="passing-data-container"></div>
    </details>

    <div id='test_result_details'>
      <h2 id='testFailures'>Failing tests ($failing_tests)</h2>
      <div id="failing-pagination-container"></div>
      <div id="failing-data-container"></div>

      <h2 id='testErrors'>Test Errors ($error_count)</h2>
      <div id="error-pagination-container"></div>
      <div id="error-data-container"></div>

      <h2 id='testUnsupported'>Unsupported Tests  ($unsupported_count)</h2>
      <div id="unsupported-pagination-container"></div>
      <div id="unsupported-data-container"></div>

      <div id='testFailures'>
        <h3>Failures characterized</h3>
        <p>Filtered count = <span id='selectedCount'>0</span>
          <button id="showSelected" onclick="showSelectedItems();">"Update display"</button>
        </p>$failures_characterized
      </div>
    </div>

  </body>
</html>
